@page "/edit"
@layout MainLayout

<h2 class="rz-text-center rz-mb-4">Edit My Gallery</h2>

<RadzenDropZoneContainer TItem="NftItem"
                         Data="@AllNfts"
                         ItemSelector="@ItemSelector"
                         Drop="@OnDrop">
    <ChildContent>
        <div class="edit-zone-wrapper rz-p-4 rz-gap-4 rz-display-flex rz-flex-wrap">
            <div class="zone-box rz-flex-grow-1 rz-border-radius-2 rz-p-3 rz-shadow-md rz-background-color-info-lighter">
                <RadzenText Text="üéØ Selected NFTs (Max 8)" TextStyle="TextStyle.Subtitle2" />
                <RadzenDropZone TItem="NftItem"
                                Value="@( "Selected" )"
                                class="edit-grid rz-mt-2" />
            </div>

            <div class="zone-box rz-flex-grow-1 rz-border-radius-2 rz-p-3 rz-shadow-md rz-background-color-warning-lighter">
                <RadzenText Text="üì¶ Available NFTs" TextStyle="TextStyle.Subtitle2" />
                <RadzenDropZone TItem="NftItem"
                                Value="@( "Available" )"
                                class="edit-grid rz-mt-2" />
            </div>
        </div>
    </ChildContent>

    <Template Context="item">
        <EditGalleryCard Title="@item.Title"
                         Metadata="@item.Metadata"
                         ImageUrl="@item.ImageUrl" />
    </Template>
</RadzenDropZoneContainer>

<div class="rz-mt-4 rz-text-center">
    <RadzenButton Text="üíæ Save Gallery"
                  Click="@SaveGallery"
                  Disabled="@(!SelectedNfts.Any())"
                  Style="min-width: 200px;" />
</div>

@code {

    private List<NftItem> AllNfts = new();
    private List<NftItem> SelectedNfts => AllNfts.Where(n => n.Status == "Selected").ToList();

    [Inject] private IJSRuntime JS { get; set; } = default!;
    private string? VisitorUP;
    private string? HostUP;

    protected override async Task OnInitializedAsync()
    {
        var isLukso = await JS.InvokeAsync<bool>("eval", "typeof window.lukso !== 'undefined'");
        if (!isLukso)
        {
            Console.WriteLine("‚ö†Ô∏è Not inside LUKSO Grid ‚Äì skipping EditGallery init.");
            return;
        }

        try
        {
            VisitorUP = await JS.InvokeAsync<string>("lukso.getVisitorUP");
            HostUP = await JS.InvokeAsync<string>("lukso.getHostUP");

            Console.WriteLine($"üßë VisitorUP: {VisitorUP}");
            Console.WriteLine($"üè† HostUP: {HostUP}");

            AllNfts = await JS.InvokeAsync<List<NftItem>>("lukso.loadMockNfts");
        }
        catch (JSException jsEx)
        {
            Console.Error.WriteLine("üö® JS error during UP fetch: " + jsEx.Message);
        }
    }

    private bool ItemSelector(NftItem item, RadzenDropZone<NftItem> zone) =>
        item.Status == (string)zone.Value;

    private void OnDrop(RadzenDropZoneItemEventArgs<NftItem> args)
    {
        if (args.FromZone != args.ToZone)
            args.Item.Status = (string)args.ToZone.Value;

        if (args.ToItem != null && args.ToItem != args.Item)
        {
            AllNfts.Remove(args.Item);
            var insertIndex = AllNfts.IndexOf(args.ToItem);
            AllNfts.Insert(insertIndex, args.Item);
        }
    }

    private async void SaveGallery()
    {
        var items = SelectedNfts.Select(nft => new
        {
            tokenContract = "0x1234567890abcdef...", // üîÅ replace with actual logic later
            tokenId = "0x" + Guid.NewGuid().ToString("N").PadRight(64, '0') // üîÅ placeholder
        }).ToList();

        var result = await JS.InvokeAsync<bool>(
            "lukso.saveGallery",
            "0x863382cD5B07e9Cd70f198Dec5D04e4cB90f035c", // ‚úÖ your deployed contract address
            items
        );

        Console.WriteLine(result ? "‚úÖ Gallery saved on-chain!" : "‚ùå Failed to save.");
    }

}